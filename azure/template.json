{"$schema":"https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"serviceName":{"type":"string"},"resourceEnvironmentName":{"type":"string"},"environmentName":{"type":"string"},"sharedEnvResourceGroup":{"type":"string"},"sharedFrontEndAppServicePlanName":{"type":"string"},"sharedFrontEndSubnetResourceId":{"type":"string"},"sharedBackEndAppServicePlanName":{"type":"string"},"sharedBackEndSubnetResourceId":{"type":"string"},"configurationStorageConnectionString":{"type":"securestring"},"loggingRedisConnectionString":{"type":"securestring"},"sharedKeyVaultName":{"type":"string"},"sharedManagementResourceGroup":{"type":"string"},"backEndAccessRestrictions":{"type":"array"},"frontEndAccessRestrictions":{"type":"array"},"uiCustomHostname":{"type":"string"},"uiCertificateName":{"type":"string"},"apiCustomHostname":{"type":"string"},"apiCertificateName":{"type":"string"},"tags":{"type":"object"},"resourceGroupLocation":{"type":"string"},"sharedApimResourceGroup":{"type":"string"},"sharedApimName":{"type":"string"},"sharedSQLServerName":{"type":"string"},"logAnalyticsWorkspaceName":{"type":"string"},"elasticPoolName":{"defaultValue":"","type":"string"},"databaseSkuName":{"type":"string","defaultValue":"S0"},"databaseTier":{"type":"string","defaultValue":"Standard"},"utcValue":{"type":"string","defaultValue":"[utcNow()]"},"stubAuth":{"type":"string"},"minimumTlsVersion":{"type":"string","defaultValue":"TLS1_2"},"ProvidersExemptedFromHavingTrustees":{"type":"string"}},"variables":{"deploymentUrlBase":"https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/","resourceNamePrefix":"[concat(\u0027das-\u0027,toLower(parameters(\u0027resourceEnvironmentName\u0027)),\u0027-\u0027 , parameters(\u0027serviceName\u0027))]","resourceGroupName":"[concat(variables(\u0027resourceNamePrefix\u0027), \u0027-rg\u0027)]","uiAppServiceName":"[concat(variables(\u0027resourceNamePrefix\u0027),\u0027ui-as\u0027)]","apiAppServiceName":"[concat(variables(\u0027resourceNamePrefix\u0027),\u0027api-as\u0027)]","storageAccountName":"[concat(\u0027das\u0027,toLower(parameters(\u0027resourceEnvironmentName\u0027)),parameters(\u0027serviceName\u0027),\u0027str\u0027)]","databaseName":"[concat(variables(\u0027resourceNamePrefix\u0027),\u0027-db\u0027)]","applyWebConfigNames":"SFA.DAS.ApplyService:ApplyConfig,SFA.DAS.Apply.GovSignIn","privateLinkScopeName":"[toLower(concat(\u0027das-\u0027, parameters(\u0027resourceEnvironmentName\u0027),\u0027-shared-ampls\u0027))]"},"resources":[{"apiVersion":"2020-06-01","name":"[variables(\u0027resourceGroupName\u0027)]","type":"Microsoft.Resources/resourceGroups","location":"[parameters(\u0027resourceGroupLocation\u0027)]","tags":"[parameters(\u0027tags\u0027)]","properties":{}},{"apiVersion":"2020-06-01","name":"[concat(variables(\u0027uiAppServiceName\u0027), \u0027-app-insights-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[variables(\u0027resourceGroupName\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027application-insights.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"appInsightsName":{"value":"[variables(\u0027uiAppServiceName\u0027)]"},"attachedService":{"value":"[variables(\u0027uiAppServiceName\u0027)]"}}}},{"apiVersion":"2020-06-01","name":"[concat(variables(\u0027apiAppServiceName\u0027), \u0027-app-insights-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[variables(\u0027resourceGroupName\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027application-insights.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"appInsightsName":{"value":"[variables(\u0027apiAppServiceName\u0027)]"},"attachedService":{"value":"[variables(\u0027apiAppServiceName\u0027)]"}}},"dependsOn":[]},{"apiVersion":"2020-06-01","name":"[concat(\u0027ui-\u0027,parameters(\u0027uiCertificateName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[parameters(\u0027sharedEnvResourceGroup\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027app-service-certificate.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"keyVaultCertificateName":{"value":"[parameters(\u0027uiCertificateName\u0027)]"},"keyVaultName":{"value":"[parameters(\u0027sharedKeyVaultName\u0027)]"},"keyVaultResourceGroup":{"value":"[parameters(\u0027sharedManagementResourceGroup\u0027)]"}}}},{"apiVersion":"2020-06-01","name":"[concat(\u0027api-\u0027,parameters(\u0027apiCertificateName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[parameters(\u0027sharedEnvResourceGroup\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027app-service-certificate.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"keyVaultCertificateName":{"value":"[parameters(\u0027apiCertificateName\u0027)]"},"keyVaultName":{"value":"[parameters(\u0027sharedKeyVaultName\u0027)]"},"keyVaultResourceGroup":{"value":"[parameters(\u0027sharedManagementResourceGroup\u0027)]"}}}},{"apiVersion":"2020-06-01","name":"[concat(variables(\u0027uiAppServiceName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[variables(\u0027resourceGroupName\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027app-service-v2.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"appServiceName":{"value":"[variables(\u0027uiAppServiceName\u0027)]"},"appServicePlanName":{"value":"[parameters(\u0027sharedFrontEndAppServicePlanName\u0027)]"},"appServicePlanResourceGroup":{"value":"[parameters(\u0027sharedEnvResourceGroup\u0027)]"},"subnetResourceId":{"value":"[parameters(\u0027sharedFrontEndSubnetResourceId\u0027)]"},"appServiceAppSettings":{"value":{"array":[{"name":"ConfigurationStorageConnectionString","value":"[parameters(\u0027configurationStorageConnectionString\u0027)]"},{"name":"EnvironmentName","value":"[parameters(\u0027environmentName\u0027)]"},{"name":"APPLICATIONINSIGHTS_CONNECTION_STRING","value":"[reference(concat(variables(\u0027uiAppServiceName\u0027), \u0027-app-insights-\u0027, parameters(\u0027utcValue\u0027))).outputs.ConnectionString.value]"},{"name":"ResourceEnvironmentName","value":"[parameters(\u0027resourceEnvironmentName\u0027)]"},{"name":"ConfigNames","value":"[variables(\u0027applyWebConfigNames\u0027)]"},{"name":"StubAuth","value":"[parameters(\u0027stubAuth\u0027)]"},{"name":"ProvidersExemptedFromHavingTrustees","value":"[parameters(\u0027ProvidersExemptedFromHavingTrustees\u0027)]"}]}},"appServiceConnectionStrings":{"value":{"array":[{"name":"Redis","connectionString":"[parameters(\u0027loggingRedisConnectionString\u0027)]","type":"Custom"}]}},"customHostName":{"value":"[parameters(\u0027uiCustomHostname\u0027)]"},"certificateThumbprint":{"value":"[reference(concat(\u0027ui-\u0027,parameters(\u0027uiCertificateName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))).outputs.certificateThumbprint.value]"},"ipSecurityRestrictions":{"value":"[parameters(\u0027frontEndAccessRestrictions\u0027)]"}}}},{"apiVersion":"2020-06-01","name":"[concat(variables(\u0027apiAppServiceName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[variables(\u0027resourceGroupName\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027app-service-v2.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"appServiceName":{"value":"[variables(\u0027apiAppServiceName\u0027)]"},"appServicePlanName":{"value":"[parameters(\u0027sharedBackEndAppServicePlanName\u0027)]"},"appServicePlanResourceGroup":{"value":"[parameters(\u0027SharedEnvResourceGroup\u0027)]"},"subnetResourceId":{"value":"[parameters(\u0027sharedBackEndSubnetResourceId\u0027)]"},"appServiceAppSettings":{"value":{"array":[{"name":"ConfigurationStorageConnectionString","value":"[parameters(\u0027configurationStorageConnectionString\u0027)]"},{"name":"EnvironmentName","value":"[parameters(\u0027environmentName\u0027)]"},{"name":"APPLICATIONINSIGHTS_CONNECTION_STRING","value":"[reference(concat(variables(\u0027apiAppServiceName\u0027), \u0027-app-insights-\u0027, parameters(\u0027utcValue\u0027))).outputs.ConnectionString.value]"},{"name":"FileStorage:StorageConnectionString","value":"[reference(concat(variables(\u0027storageAccountName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))).outputs.storageConnectionString.value]"}]}},"appServiceConnectionStrings":{"value":{"array":[{"name":"Redis","connectionString":"[parameters(\u0027loggingRedisConnectionString\u0027)]","type":"Custom"}]}},"customHostName":{"value":"[parameters(\u0027apiCustomHostname\u0027)]"},"certificateThumbprint":{"value":"[reference(concat(\u0027api-\u0027,parameters(\u0027apiCertificateName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))).outputs.certificateThumbprint.value]"},"ipSecurityRestrictions":{"value":"[parameters(\u0027backEndAccessRestrictions\u0027)]"}}}},{"apiVersion":"2020-06-01","name":"[concat(variables(\u0027storageAccountName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[variables(\u0027resourceGroupName\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027storage-account-arm.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"storageAccountName":{"value":"[variables(\u0027storageAccountName\u0027)]"},"allowSharedKeyAccess":{"value":true},"minimumTlsVersion":{"value":"[parameters(\u0027minimumTlsVersion\u0027)]"}}}},{"apiVersion":"2021-04-01","name":"[concat(variables(\u0027apiAppServiceName\u0027), \u0027-apim-subscription-\u0027, parameters(\u0027utcValue\u0027))]","resourceGroup":"[parameters(\u0027sharedApimResourceGroup\u0027)]","type":"Microsoft.Resources/deployments","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027apim/apim-subscription.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"apimName":{"value":"[parameters(\u0027sharedApimName\u0027)]"},"subscriptionName":{"value":"[variables(\u0027apiAppServiceName\u0027)]"},"subscriptionScope":{"value":"[concat(\u0027/subscriptions/\u0027, subscription().subscriptionId, \u0027/resourceGroups/\u0027, parameters(\u0027sharedApimResourceGroup\u0027), \u0027/providers/Microsoft.ApiManagement/service/\u0027, parameters(\u0027sharedApimName\u0027), \u0027/products/RoatpOuterApi\u0027)]"}}}},{"apiVersion":"2021-04-01","name":"[concat(variables(\u0027databaseName\u0027), \u0027-\u0027, parameters(\u0027utcValue\u0027))]","type":"Microsoft.Resources/deployments","resourceGroup":"[parameters(\u0027sharedEnvResourceGroup\u0027)]","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027sql-database.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"databaseName":{"value":"[variables(\u0027databaseName\u0027)]"},"sqlServerName":{"value":"[parameters(\u0027sharedSQLServerName\u0027)]"},"elasticPoolName":{"value":"[parameters(\u0027elasticPoolName\u0027)]"},"databaseSkuName":{"value":"[parameters(\u0027databaseSkuName\u0027)]"},"databaseTier":{"value":"[parameters(\u0027databaseTier\u0027)]"},"logAnalyticsSubscriptionId":{"value":"[subscription().subscriptionId]"},"logAnalyticsResourceGroup":{"value":"[parameters(\u0027sharedManagementResourceGroup\u0027)]"},"logAnalyticsWorkspaceName":{"value":"[parameters(\u0027logAnalyticsWorkspaceName\u0027)]"}}}},{"apiVersion":"2021-04-01","name":"[concat(variables(\u0027apiAppServiceName\u0027), \u0027-private-link-scoped-\u0027, parameters(\u0027utcValue\u0027))]","type":"Microsoft.Resources/deployments","resourceGroup":"[parameters(\u0027sharedEnvResourceGroup\u0027)]","properties":{"mode":"Incremental","templateLink":{"uri":"[concat(variables(\u0027deploymentUrlBase\u0027),\u0027private-linked-scoped-resource.json\u0027)]","contentVersion":"1.0.0.0"},"parameters":{"privateLinkScopeName":{"value":"[variables(\u0027privateLinkScopeName\u0027)]"},"scopedResourceName":{"value":"[variables(\u0027apiAppServiceName\u0027)]"},"scopedResourceId":{"value":"[reference(concat(variables(\u0027apiAppServiceName\u0027), \u0027-application-insights-\u0027, parameters(\u0027utcValue\u0027))).outputs.AppInsightsResourceId.value]"}}}}],"outputs":{"ResourceGroupName":{"type":"string","value":"[variables(\u0027resourceGroupName\u0027)]"},"UiAppServiceName":{"type":"string","value":"[variables(\u0027uiAppServiceName\u0027)]"},"ApiAppServiceName":{"type":"string","value":"[variables(\u0027apiAppServiceName\u0027)]"},"DatabaseName":{"type":"string","value":"[variables(\u0027databaseName\u0027)]"}}}
